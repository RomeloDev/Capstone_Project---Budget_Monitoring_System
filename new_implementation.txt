# Implement Admin Panel Activity Design Management System

I need to implement a complete Activity Design management system in the admin panel that matches the existing Purchase Request management structure. The AD feature supports **multiple PRE line items** with quarterly selection (unlike PR which uses single line item).

## IMPORTANT: Use Existing Models from `apps/budgets/models.py`

### Key Models (DO NOT CREATE NEW ONES - They Already Exist):

**ActivityDesign** (lines 601-707 in `apps/budgets/models.py`):
- `id` (UUIDField, primary key)
- `ad_number` (CharField, unique, e.g., "AD-2025-0001")
- `submitted_by` (ForeignKey to User)
- `department` (CharField)
- `budget_allocation` (ForeignKey to BudgetAllocation)
- `purpose` (TextField)
- `total_amount` (DecimalField)
- `status` (CharField: Pending/Partially Approved/Approved/Rejected)
- `uploaded_document` (FileField - .docx file)
- `approved_document` (FileField - signed copy)
- `submitted_at`, `partially_approved_at`, `final_approved_at` (DateTimeField)
- `partially_approved_by`, `admin_approved_by`, `rejected_by` (ForeignKey to User)
- `rejection_reason` (TextField)
- `is_valid` (BooleanField)

**ActivityDesignAllocation** (lines 896-958 in `apps/budgets/models.py`):
- `activity_design` (ForeignKey, related_name='pre_allocations')
- `pre_line_item` (ForeignKey to PRELineItem)
- `quarter` (CharField: Q1/Q2/Q3/Q4)
- `allocated_amount` (DecimalField)
- `allocated_at` (DateTimeField)
- `notes` (TextField)

**ActivityDesignSupportingDocument** (lines 1221-1265 in `apps/budgets/models.py`):
- `activity_design` (ForeignKey, related_name='supporting_documents')
- `document` (FileField)
- `file_name` (CharField)
- `file_size` (BigIntegerField)
- `is_signed_copy` (BooleanField)
- `uploaded_by` (ForeignKey to User)
- `uploaded_at` (DateTimeField)

**PRELineItem Helper Methods** (lines 709-815 in `apps/budgets/models.py`):
- `get_quarter_amount(quarter)` - Returns q1_amount, q2_amount, q3_amount, or q4_amount
- `get_quarter_consumed(quarter)` - Calculates consumed from PR/AD allocations for that quarter
- `get_quarter_available(quarter)` - Returns available budget for that quarter

**BudgetAllocation** (lines 158-191 in `apps/budgets/models.py`):
- Fields: `allocated_amount`, `pre_amount_used`, `pr_amount_used`, `ad_amount_used`, `remaining_balance`
- Method: `get_total_used()` - Returns pre_amount_used + pr_amount_used + ad_amount_used
- Method: `update_remaining_balance()` - Recalculates remaining_balance

---

## Reference Files (Use as Templates)

### PR Management (Complete Implementation - Copy This Structure):

**1. List Page:** `apps/admin_panel/templates/admin_panel/departments_pr_request.html`
- Status summary cards (Total, Pending, Partially Approved, Approved, Rejected)
- Filter modal (Department, Status)
- Table with columns: PR Number, Department, Purpose, Source of Fund, Total Amount, Date Submitted, Status, Actions

**2. Preview Page:** `apps/admin_panel/templates/admin_panel/preview_pr.html`
- Header with PR number and status badge
- 2-column grid layout (left: details, right: sidebar)
- Basic Information card
- Budget Information card (shows single line item)
- Documents section
- Status Timeline
- Budget Summary sidebar
- Actions sidebar (status-dependent buttons)

**3. Approval View:** `apps/admin_panel/views.py` - `handle_departments_request` (lines 296-485)
- Handles approve action: Converts to PDF, sets Partially Approved
- Handles reject action: Deletes allocations, returns budget, sets Rejected
- Creates notifications and audit trail

**4. Upload Signed Copy View:** `apps/admin_panel/views.py` - `admin_upload_pr_signed_copy` (lines 510-644)
- Uploads signed copy
- Sets status to Approved
- Creates notification

**5. Upload Template:** `apps/admin_panel/templates/admin_panel/upload_pr_signed_copy.html`
- Form to upload signed document
- File input for signed copy
- Multiple file input for signed supporting documents

---

## What Needs to Be Implemented

### Task 1: Update `departments_ad_request.html` List Page

**File:** `apps/admin_panel/templates/admin_panel/departments_ad_request.html`

**Current state:** Basic table, no status cards, minimal styling

**Required changes:**

1. **Add Status Summary Cards** (copy from PR):
```html
<div class="grid grid-cols-5 gap-4 mb-6">
    <!-- Total ADs Card -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-600">Total ADs</p>
                <p class="text-3xl font-bold text-gray-900">{{ status_counts.total }}</p>
            </div>
            <div class="p-3 bg-blue-100 rounded-full">
                <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
            </div>
        </div>
    </div>
    
    <!-- Pending Card (yellow) -->
    <div class="bg-yellow-50 rounded-lg shadow-sm border border-yellow-200 p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-yellow-700">Pending</p>
                <p class="text-3xl font-bold text-yellow-600">{{ status_counts.pending }}</p>
            </div>
            <div class="p-3 bg-yellow-200 rounded-full">
                <svg class="w-8 h-8 text-yellow-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
        </div>
    </div>
    
    <!-- Partially Approved Card (blue) -->
    <div class="bg-blue-50 rounded-lg shadow-sm border border-blue-200 p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-blue-700">Partially Approved</p>
                <p class="text-3xl font-bold text-blue-600">{{ status_counts.partially_approved }}</p>
            </div>
            <div class="p-3 bg-blue-200 rounded-full">
                <svg class="w-8 h-8 text-blue-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
        </div>
    </div>
    
    <!-- Approved Card (green) -->
    <div class="bg-green-50 rounded-lg shadow-sm border border-green-200 p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-green-700">Approved</p>
                <p class="text-3xl font-bold text-green-600">{{ status_counts.approved }}</p>
            </div>
            <div class="p-3 bg-green-200 rounded-full">
                <svg class="w-8 h-8 text-green-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
        </div>
    </div>
    
    <!-- Rejected Card (red) -->
    <div class="bg-red-50 rounded-lg shadow-sm border border-red-200 p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-red-700">Rejected</p>
                <p class="text-3xl font-bold text-red-600">{{ status_counts.rejected }}</p>
            </div>
            <div class="p-3 bg-red-200 rounded-full">
                <svg class="w-8 h-8 text-red-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </div>
        </div>
    </div>
</div>





Add Filter Modal (copy from PR)



Update Table:

<table class="min-w-full divide-y divide-gray-200">
    <thead class="bg-gray-50">
        <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">AD NUMBER</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DEPARTMENT</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PURPOSE</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">FUNDING SOURCES</th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">TOTAL AMOUNT</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DATE SUBMITTED</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">STATUS</th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ACTIONS</th>
        </tr>
    </thead>
    <tbody class="bg-white divide-y divide-gray-200">
        {% for ad in ads %}
        <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900">{{ ad.ad_number }}</div>
            </td>
            <td class="px-6 py-4">
                <div class="text-sm font-medium text-gray-900">{{ ad.department }}</div>
                <div class="text-xs text-gray-500">{{ ad.submitted_by.get_full_name }}</div>
            </td>
            <td class="px-6 py-4">
                <div class="text-sm text-gray-900">{{ ad.purpose|truncatewords:10 }}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-indigo-100 text-indigo-800">
                    {{ ad.pre_allocations.count }} Line Item{{ ad.pre_allocations.count|pluralize }}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right">
                <div class="text-sm font-semibold text-gray-900">‚Ç±{{ ad.total_amount|floatformat:2|intcomma }}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">{{ ad.submitted_at|date:"M d, Y" }}</div>
                <div class="text-xs text-gray-500">{{ ad.submitted_at|time:"g:i A" }}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full
                    {% if ad.status == 'Pending' %}bg-yellow-100 text-yellow-800
                    {% elif ad.status == 'Partially Approved' %}bg-blue-100 text-blue-800
                    {% elif ad.status == 'Approved' %}bg-green-100 text-green-800
                    {% else %}bg-red-100 text-red-800{% endif %}">
                    {{ ad.status }}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <a href="{% url 'admin_preview_ad' ad.id %}" class="text-blue-600 hover:text-blue-900">View Details</a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>



Task 2: Create admin_preview_ad.html Template

Create new file: apps/admin_panel/templates/admin_panel/admin_preview_ad.html

Use preview_pr.html as reference but adapt for multiple line items

Structure:

{% extends "admin_base_template/dashboard.html" %}
{% load humanize %}

{% block title %}AD {{ ad.ad_number }} - Preview{% endblock %}

{% block main-content %}
<main class="content space-y-6">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">{{ ad.ad_number }}</h1>
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium mt-2
                    {% if ad.status == 'Pending' %}bg-yellow-100 text-yellow-800
                    {% elif ad.status == 'Partially Approved' %}bg-blue-100 text-blue-800
                    {% elif ad.status == 'Approved' %}bg-green-100 text-green-800
                    {% else %}bg-red-100 text-red-800{% endif %}">
                    {{ ad.status }}
                </span>
            </div>
            <div class="flex gap-2">
                <a href="{% url 'departments_ad_request' %}" class="btn-secondary">‚Üê Back</a>
                <button onclick="window.print()" class="btn-secondary">üñ®Ô∏è Print</button>
            </div>
        </div>
    </div>
    
    <!-- Grid Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Column (2/3) -->
        <div class="lg:col-span-2 space-y-6">
            
            <!-- Basic Information -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">üìã Basic Information</h2>
                <dl class="grid grid-cols-2 gap-4">
                    <div>
                        <dt class="text-sm font-medium text-gray-500">AD Number</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ ad.ad_number }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Department</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ ad.department }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Submitted By</dt>
                        <dd class="mt-1 text-sm text-gray-900">
                            {{ ad.submitted_by.get_full_name }}<br>
                            <span class="text-xs text-gray-500">{{ ad.submitted_by.email }}</span>
                        </dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Date Submitted</dt>
                        <dd class="mt-1 text-sm text-gray-900">
                            {{ ad.submitted_at|date:"M d, Y" }}<br>
                            <span class="text-xs text-gray-500">{{ ad.submitted_at|time:"g:i A" }}</span>
                        </dd>
                    </div>
                    <div class="col-span-2">
                        <dt class="text-sm font-medium text-gray-500">Purpose</dt>
                        <dd class="mt-1 text-sm text-gray-900">{{ ad.purpose }}</dd>
                    </div>
                </dl>
            </div>
            
            <!-- Budget Information -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">üí∞ Budget Information</h2>
                <dl class="grid grid-cols-2 gap-4">
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Total Amount</dt>
                        <dd class="mt-1 text-lg font-bold text-blue-600">‚Ç±{{ ad.total_amount|floatformat:2|intcomma }}</dd>
                    </div>
                    <div>
                        <dt class="text-sm font-medium text-gray-500">Budget Allocation</dt>
                        <dd class="mt-1 text-sm text-gray-900">
                            {{ ad.budget_allocation.approved_budget.title }}<br>
                            <span class="text-xs text-gray-500">Remaining: ‚Ç±{{ ad.budget_allocation.remaining_balance|floatformat:2|intcomma }}</span>
                        </dd>
                    </div>
                    <div class="col-span-2">
                        <dt class="text-sm font-medium text-gray-500">Funding Sources</dt>
                        <dd class="mt-1">
                            <span class="px-3 py-1 bg-indigo-100 text-indigo-800 rounded-full text-sm font-semibold">
                                {{ budget_summary.line_items_count }} Line Item{{ budget_summary.line_items_count|pluralize }}
                            </span>
                        </dd>
                    </div>
                </dl>
            </div>
            
            <!-- Funding Breakdown Table (CRITICAL - Shows Multiple Line Items) -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">üìä Funding Breakdown</h2>
                <p class="text-sm text-gray-600 mb-4">
                    This AD uses {{ budget_summary.line_items_count }} PRE line item{{ budget_summary.line_items_count|pluralize }} as funding source{{ budget_summary.line_items_count|pluralize }}.
                </p>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PRE Line Item</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Quarter</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Available After</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for item in allocations %}
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3">
                                    <div class="text-sm font-medium text-gray-900">{{ item.allocation.pre_line_item.item_name }}</div>
                                </td>
                                <td class="px-4 py-3">
                                    <div class="text-sm text-gray-600">
                                        {% if item.allocation.pre_line_item.category %}{{ item.allocation.pre_line_item.category.name }}{% endif %}
                                    </div>
                                </td>
                                <td class="px-4 py-3 text-center">
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                                        {{ item.allocation.quarter }}
                                    </span>
                                </td>
                                <td class="px-4 py-3 text-right">
                                    <span class="text-sm font-semibold text-gray-900">‚Ç±{{ item.allocation.allocated_amount|floatformat:2|intcomma }}</span>
                                </td>
                                <td class="px-4 py-3 text-right">
                                    <span class="text-sm text-green-600">‚Ç±{{ item.quarter_remaining|floatformat:2|intcomma }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="bg-gray-50">
                            <tr>
                                <td colspan="3" class="px-4 py-3 text-right text-sm font-bold text-gray-900">TOTAL AD AMOUNT:</td>
                                <td class="px-4 py-3 text-right">
                                    <span class="text-lg font-bold text-blue-600">‚Ç±{{ ad.total_amount|floatformat:2|intcomma }}</span>
                                </td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            
            <!-- Documents Section (copy from PR) -->
            <!-- Status Timeline (copy from PR) -->
        </div>
        
        <!-- Right Column (1/3) - Sidebar -->
        <div class="lg:col-span-1 space-y-6">
            <!-- Budget Summary (see above) -->
            <!-- Actions Card (see above) -->
        </div>
    </div>
</main>
{% endblock %}



Task 3: Create admin_preview_ad View

File: apps/admin_panel/views.py

Add after admin_preview_pr view (around line 678):

See the view code I provided in the previous response (lines 3897-3949 logic)



Task 4: Fix handle_activity_design_request View

File: apps/admin_panel/views.py (lines 2421-2507)

CRITICAL BUG on line 2470-2490 - MUST FIX:

Current code (WRONG):

line_item.consumed_amount -= allocated_amount  # ‚ùå Field doesn't exist!

Fixed code:

# Just track for logging - deletion handles budget release
total_released += allocated_amount
released_details.append(f"{line_item.item_name} {quarter}: ‚Ç±{allocated_amount:,.2f}")

# Delete allocations
allocations.delete()

# Update budget allocation
activity_design.budget_allocation.ad_amount_used -= total_released
activity_design.budget_allocation.update_remaining_balance()



Task 5: Create admin_upload_ad_signed_copy View

File: apps/admin_panel/views.py

Add after admin_upload_pr_signed_copy (around line 645):

See the complete view code I provided in the previous response



Task 6: Create upload_ad_signed_copy.html Template

Create: apps/admin_panel/templates/admin_panel/upload_ad_signed_copy.html

Copy from upload_pr_signed_copy.html and change:





All pr variables to ad



"Purchase Request" to "Activity Design"



Form action to admin_upload_ad_signed_copy



File input name from signed_pr to signed_ad



Task 7: Update departments_ad_request View

File: apps/admin_panel/views.py (lines 2397-2420)

See the enhanced view code I provided in the previous response



Task 8: Add URL Patterns

File: apps/admin_panel/urls.py

Add these patterns:

# Activity Design Management
path('ad/', views.departments_ad_request, name='departments_ad_request'),
path('ad/preview/<uuid:ad_id>/', views.admin_preview_ad, name='admin_preview_ad'),
path('ad/<uuid:ad_id>/handle/', views.handle_activity_design_request, name='handle_activity_design_request'),
path('ad/<uuid:ad_id>/upload-signed-copy/', views.admin_upload_ad_signed_copy, name='admin_upload_ad_signed_copy'),



Task 9: Add Properties to DepartmentPRE Model

File: apps/budgets/models.py

Add to DepartmentPRE class (around line 370):

See the @property total_consumed and @property total_remaining code I provided



Key Differences: PR vs AD

Purchase Request (Single Line Item):





Budget Info shows: One source of fund



Simple display: "Overtime Pay - Q2: ‚Ç±700"



One PurchaseRequestAllocation record

Activity Design (Multiple Line Items):





Budget Info shows: Count of funding sources



Table display with multiple rows



Multiple ActivityDesignAllocation records



Example:

Overtime Pay - Q1: ‚Ç±700
Training - Q2: ‚Ç±500
Travelling - Q3: ‚Ç±300
Total: ‚Ç±1,500

Rejection Logic:





PR: Delete 1 allocation, release from 1 quarter



AD: Loop through allocations, delete all, release from multiple quarters



Testing Checklist

After implementation, test:





[ ] View AD list with status cards showing correct counts



[ ] Filter by department and status



[ ] Click "View Details" - see complete AD with multi-line item table



[ ] Budget summary shows correct PRE/PR/AD breakdown



[ ] Approve button works (Pending ‚Üí Partially Approved, converts to PDF)



[ ] Download PDF works



[ ] Upload signed copy works (Partially Approved ‚Üí Approved)



[ ] Reject works (budget released from all quarters)



[ ] Notifications created



[ ] Audit trail logged



Expected Result

Admin can manage Activity Designs with the same professional interface as Purchase Requests, with proper support for multiple PRE line items and quarterly budget tracking.