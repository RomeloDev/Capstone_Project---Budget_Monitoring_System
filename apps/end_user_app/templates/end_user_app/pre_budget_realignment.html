{% extends "end_user_base_template/dashboard.html" %}
{% load humanize %}

{% block title %}PRE Budget Realignment{% endblock title %}

{% block main-content %}
<main class="content">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">PRE Budget Realignment</h1>
            <p class="text-gray-600">
                Realign budget between expense categories within your approved PREs. 
                Transfer funds from categories with surplus to those that need additional budget.
            </p>
        </header>

    <div class="max-w-4xl mx-auto">

        <!-- Available Categories Overview -->
        {% if available_categories %}
        <section class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Available Budget Categories</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for category in available_categories %}
                <div class="border border-gray-200 rounded-lg p-4">
                    <h3 class="font-medium text-gray-900 mb-1">{{ category.label|truncatechars:50 }}</h3>
                    <p class="text-sm text-gray-600">Available: <span class="font-semibold text-green-600">₱{{ category.remaining|floatformat:2|intcomma }}</span></p>
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}


        <!-- Messages -->
        {% if messages %}
        <section class="mt-6">
            {% for message in messages %}
            <div class="p-4 rounded-lg mb-4 {% if message.tags == 'success' %}bg-green-50 text-green-800 border border-green-200{% elif message.tags == 'error' %}bg-red-50 text-red-800 border border-red-200{% else %}bg-blue-50 text-blue-800 border border-blue-200{% endif %}">
                {{ message }}
            </div>
            {% endfor %}
        </section>
        {% endif %}

        <!-- Navigation and Actions -->
        <section class="mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <nav class="text-sm text-gray-600">
                        <a href="{% url 'user_dashboard' %}" class="hover:text-blue-600">Dashboard</a>
                        <span class="mx-2">›</span>
                        <span class="text-gray-900">Budget Realignment</span>
                    </nav>
                </div>
                <div class="flex space-x-3">
                    <a href="{% url 'realignment_history' %}" 
                    class="inline-flex items-center px-4 py-2 bg-blue-600 text-gray-50 rounded-lg hover:bg-blue-700 transition duration-200 font-medium">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        View History
                    </a>
                </div>
            </div>
        </section>


        <!-- Realignment Form -->
        <section class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold text-gray-800 mb-6">Submit Realignment Request</h2>
            
            <form method="POST" class="space-y-6">
                {% csrf_token %}
                
                <!-- Source Category -->
                <div>
                    <label for="source_category" class="block text-sm font-medium text-gray-700 mb-2">
                        Source Category (Transfer FROM)
                    </label>
                    <select id="source_category" name="source_category" required 
                            class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">-- Select source category --</option>
                        {% for category in available_categories %}
                        <option value="{{ category.value }}" data-remaining="{{ category.remaining }}">
                            {{ category.label }}
                        </option>
                        {% endfor %}
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Choose the category you want to transfer budget from</p>
                </div>

                <!-- Target Category -->
                <div>
                    <label for="target_category" class="block text-sm font-medium text-gray-700 mb-2">
                        Target Category (Transfer TO)
                    </label>
                    <select id="target_category" name="target_category" required 
                            class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">-- Select target category --</option>
                        {% for category in available_categories %}
                        <option value="{{ category.value }}">
                            {{ category.label }}
                        </option>
                        {% endfor %}
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Choose the category you want to transfer budget to</p>
                </div>

                <!-- Amount -->
                <div>
                    <label for="amount" class="block text-sm font-medium text-gray-700 mb-2">
                        Amount to Transfer (₱)
                    </label>
                    <input type="number" id="amount" name="amount" min="0.01" step="0.01" required
                           class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           placeholder="0.00">
                    <p class="text-xs text-gray-500 mt-1" id="amount-validation"></p>
                </div>

                <!-- Reason -->
                <div>
                    <label for="reason" class="block text-sm font-medium text-gray-700 mb-2">
                        Reason for Realignment
                    </label>
                    <textarea id="reason" name="reason" rows="4" required
                              class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                              placeholder="Explain why you need to realign this budget..."></textarea>
                </div>

                <!-- Submit Button -->
                <div class="flex justify-end">
                    <button type="submit" 
                            class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition duration-200 font-medium">
                        Submit Realignment Request
                    </button>
                </div>
            </form>
        </section>

    </div>
</main>

<script>
// Form validation
document.addEventListener('DOMContentLoaded', function() {
    const sourceSelect = document.getElementById('source_category');
    const targetSelect = document.getElementById('target_category');
    const amountInput = document.getElementById('amount');
    const amountValidation = document.getElementById('amount-validation');

    function validateAmount() {
        const sourceOption = sourceSelect.selectedOptions[0];
        const amount = parseFloat(amountInput.value) || 0;
        
        if (sourceOption && sourceOption.dataset.remaining) {
            const available = parseFloat(sourceOption.dataset.remaining);
            
            if (amount > available) {
                amountValidation.textContent = `Amount exceeds available budget (₱${available.toLocaleString()})`;
                amountValidation.className = 'text-xs text-red-500 mt-1';
                return false;
            } else if (amount > 0) {
                amountValidation.textContent = `Valid amount (₱${available.toLocaleString()} available)`;
                amountValidation.className = 'text-xs text-green-500 mt-1';
                return true;
            }
        }
        
        amountValidation.textContent = '';
        return true;
    }

    function validateCategories() {
        if (sourceSelect.value && targetSelect.value && sourceSelect.value === targetSelect.value) {
            targetSelect.setCustomValidity('Source and target categories cannot be the same');
        } else {
            targetSelect.setCustomValidity('');
        }
    }

    sourceSelect.addEventListener('change', function() {
        validateAmount();
        validateCategories();
    });

    targetSelect.addEventListener('change', validateCategories);
    amountInput.addEventListener('input', validateAmount);
});
</script>
{% endblock main-content %}