{% extends "end_user_base_template/dashboard.html" %}
{% load humanize %}

{% block title %}Department PRE Form{% endblock %}

{% block main-content %}
<main class="content p-6">
    <header class="mb-6">
        <h1 class="font-semibold text-3xl">Department PRE Form</h1>
        <p class="text-gray-600">Compile the Program of Receipts and Expenditures (PRE) for your department.</p>
    </header>

    <form id="preForm" method="post" action="">
        {% csrf_token %}
        <section class="mb-10">
            <div>
                <h2 class="text-xl font-bold mb-4">Personnel Services</h2>
                <div class="mb-6 border-l-4 border-yellow-400 pl-4" data-category="personnel">
                        {% for item in personnel_services %}
                        <div class="grid grid-cols-7 gap-4 items-center mb-2">
                                <label class="col-span-2 font-medium">{{ item.label }}</label>
                                <input type="number" name="{{ item.name }}_q1" class="form-input" min="0" placeholder="Q1" step="0.01">
                                <input type="number" name="{{ item.name }}_q2" class="form-input" min="0" placeholder="Q2" step="0.01">
                                <input type="number" name="{{ item.name }}_q3" class="form-input" min="0" placeholder="Q3" step="0.01">
                                <input type="number" name="{{ item.name }}_q4" class="form-input" min="0" placeholder="Q4" step="0.01">
                                <input type="number" name="{{ item.name }}_total" class="form-input" min="0" placeholder="TOTAL" step="0.01">
                        </div>
                        {% endfor %}
                    
                    <div class="grid grid-cols-7 gap-4 items-center mb-2">
                        <label class="col-span-2 font-bold underline">Total Personnel Services</label>
                        <input class="border-gray-950 border-2" type="number" min="0" name="total_personnel_q1_total" class="form-input" placeholder="Q1 Total" step="0.01">
                        <input class="border-gray-950 border-2" type="number" min="0" name="total_personnel_q2_total" class="form-input" placeholder="Q2 Total" step="0.01">
                        <input class="border-gray-950 border-2" type="number" min="0" name="total_personnel_q3_total" class="form-input" placeholder="Q3 Total" step="0.01">
                        <input class="border-gray-950 border-2" type="number" min="0" name="total_personnel_q4_total" class="form-input" placeholder="Q4 Total" step="0.01">
                    </div>
                </div>
            </div>

            <h2 class="text-xl font-bold mb-4">Maintenance and Other Operating Expenses</h2>

            <!-- MOOE Section -->
            <div class="mb-6 border-l-4 border-blue-500 pl-4" data-category="mooe">
                <!--Traveling Expenses section-->
                <h3 class="text-lg font-semibold mb-1">Traveling Expenses</h3>
                        {% for item in MOOE_traveling_expenses %}
                        <div class="grid grid-cols-7 gap-4 items-center mb-2">
                                <label class="col-span-2 font-medium">{{ item.label }}</label>
                                <input type="number" name="{{ item.name }}_q1" class="form-input" min="0" placeholder="Q1" step="0.01">
                                <input type="number" name="{{ item.name }}_q2" class="form-input" min="0" placeholder="Q2" step="0.01">
                                <input type="number" name="{{ item.name }}_q3" class="form-input" min="0" placeholder="Q3" step="0.01">
                                <input type="number" name="{{ item.name }}_q4" class="form-input" min="0" placeholder="Q4" step="0.01">
                                <input type="number" name="{{ item.name }}_total" class="form-input" min="0" placeholder="TOTAL" step="0.01">
                        </div>
                        {% endfor %}

                <!-- Training and Scholarship Expenses Section -->
                <h3 class="text-lg font-semibold mb-1">Training and Scholarship Expenses</h3>
                        {% for item in MOOE_training_and_scholarship_expenses %}
                        <div class="grid grid-cols-7 gap-4 items-center mb-2">
                                <label class="col-span-2 font-medium">{{ item.label }}</label>
                                <input type="number" name="{{ item.name }}_q1" class="form-input" min="0" placeholder="Q1" step="0.01">
                                <input type="number" name="{{ item.name }}_q2" class="form-input" min="0" placeholder="Q2" step="0.01">
                                <input type="number" name="{{ item.name }}_q3" class="form-input" min="0" placeholder="Q3" step="0.01">
                                <input type="number" name="{{ item.name }}_q4" class="form-input" min="0" placeholder="Q4" step="0.01">
                                <input type="number" name="{{ item.name }}_total" class="form-input" min="0" placeholder="TOTAL" step="0.01">
                        </div>
                        {% endfor %}

                <!-- Line Item: Supplies and Materials  Expenses -->
                <h3 class="text-lg font-semibold mb-1">Supplies and Materials Expenses</h3>
                        {% for item in MOOE_supplies_and_materials_expenses %}
                        <div class="grid grid-cols-7 gap-4 items-center mb-2">
                                <label class="col-span-2 font-medium">{{ item.label }}</label>
                                <input type="number" name="{{ item.name }}_q1" class="form-input" min="0" placeholder="Q1" step="0.01">
                                <input type="number" name="{{ item.name }}_q2" class="form-input" min="0" placeholder="Q2" step="0.01">
                                <input type="number" name="{{ item.name }}_q3" class="form-input" min="0" placeholder="Q3" step="0.01">
                                <input type="number" name="{{ item.name }}_q4" class="form-input" min="0" placeholder="Q4" step="0.01">
                                <input type="number" name="{{ item.name }}_total" class="form-input" min="0" placeholder="TOTAL" step="0.01">
                        </div>
                        {% endfor %}
                
                <!--Semi-Expendable Machinery and Equipment Expenses-->
                <h3 class="text-lg font-semibold mb-1">Semi-Expendable Machinery and Equipment Expenses</h3>
                        {% for item in MOOE_semi_expendable_machinery_equipment_expenses %}
                        <div class="grid grid-cols-7 gap-4 items-center mb-2">
                                <label class="col-span-2 font-medium">{{ item.label }}</label>
                                <input type="number" name="{{ item.name}}_q1" class="form-input" min="0" placeholder="Q1" step="0.01">
                                <input type="number" name="{{ item.name}}_q2" class="form-input" min="0" placeholder="Q2" step="0.01">
                                <input type="number" name="{{ item.name}}_q3" class="form-input" min="0" placeholder="Q3" step="0.01">
                                <input type="number" name="{{ item.name}}_q4" class="form-input" min="0" placeholder="Q4" step="0.01">
                                <input type="number" name="{{ item.name}}_total" class="form-input" min="0" placeholder="TOTAL" step="0.01">
                        </div>
                        {% endfor %}

                <!-- Semi-Expendable Furniture, Fixtures, and Books Expenses -->
                <h3 class="text-lg font-semibold mb-1">Semi-Expendable Furniture, Fixtures and Books Expenses</h3>
                        {% for item in MOOE_semi_expendable_furnitures_fixtures_books_expenses %}
                        <div class="grid grid-cols-7 gap-4 items-center mb-2">
                                <label class="col-span-2 font-medium">{{ item.label }}</label>
                                <input type="number" name="{{ item.name }}_q1" class="form-input" min="0" placeholder="Q1" step="0.01">
                                <input type="number" name="{{ item.name }}_q2" class="form-input" min="0" placeholder="Q2" step="0.01">
                                <input type="number" name="{{ item.name }}_q3" class="form-input" min="0" placeholder="Q3" step="0.01">
                                <input type="number" name="{{ item.name }}_q4" class="form-input" min="0" placeholder="Q4" step="0.01">
                                <input type="number" name="{{ item.name }}_total" class="form-input" min="0" placeholder="TOTAL" step="0.01">
                        </div>
                        {% endfor %}

                <!-- Utility Expenses section-->
                <h3 class="text-lg font-semibold mb-1">Utility Expenses</h3>
                        {% for item in MOOE_utility_expenses %}
                        <div class="grid grid-cols-7 gap-4 items-center mb-2">
                                <label class="col-span-2 font-medium">{{ item.label }}</label>
                                <input type="number" name="{{ item.name }}_q1" class="form-input" min="0" placeholder="Q1" step="0.01">
                                <input type="number" name="{{ item.name }}_q2" class="form-input" min="0" placeholder="Q2" step="0.01">
                                <input type="number" name="{{ item.name }}_q3" class="form-input" min="0" placeholder="Q3" step="0.01">
                                <input type="number" name="{{ item.name }}_q4" class="form-input" min="0" placeholder="Q4" step="0.01">
                                <input type="number" name="{{ item.name }}_total" class="form-input" min="0" placeholder="TOTAL" step="0.01">
                        </div>
                        {% endfor %}

                <!-- Communication Expenses section-->
                <h3 class="text-lg font-semibold mb-1">Communication Expenses</h3>
                        {% for item in MOOE_communication_expenses %}
                        <div class="grid grid-cols-7 gap-4 items-center mb-2">
                                <label class="col-span-2 font-medium">{{ item.label }}</label>
                                <input type="number" name="{{ item.name }}_q1" class="form-input" min="0" placeholder="Q1" step="0.01">
                                <input type="number" name="{{ item.name }}_q2" class="form-input" min="0" placeholder="Q2" step="0.01">
                                <input type="number" name="{{ item.name }}_q3" class="form-input" min="0" placeholder="Q3" step="0.01">
                                <input type="number" name="{{ item.name }}_q4" class="form-input" min="0" placeholder="Q4" step="0.01">
                                <input type="number" name="{{ item.name }}_total" class="form-input" min="0" placeholder="TOTAL" step="0.01">
                        </div>
                        {% endfor %}

                <!-- Awards/Rewards and Prizes section-->
                <h3 class="text-lg font-semibold mb-1">Awards/Rewards and Prizes</h3>
                        {% for item in MOOE_awards_rewards_prizes %}
                        <div class="grid grid-cols-7 gap-4 items-center mb-2">
                                <label class="col-span-2 font-medium">{{ item.label }}</label>
                                <input type="number" name="{{ item.name }}_q1" class="form-input" min="0" placeholder="Q1" step="0.01">
                                <input type="number" name="{{ item.name }}_q2" class="form-input" min="0" placeholder="Q2" step="0.01">
                                <input type="number" name="{{ item.name }}_q3" class="form-input" min="0" placeholder="Q3" step="0.01">
                                <input type="number" name="{{ item.name }}_q4" class="form-input" min="0" placeholder="Q4" step="0.01">
                                <input type="number" name="{{ item.name }}_total" class="form-input" min="0" placeholder="TOTAL" step="0.01">
                        </div>
                        {% endfor %}

                <!-- Survey, Research, Exploration, and Development Section-->
                <h3 class="text-lg font-semibold mb-1">Survey, Research, Exploration, and Development</h3>
                        {% for item in MOOE_survey_research_exploration_development %}
                        <div class="grid grid-cols-7 gap-4 items-center mb-2">
                                <label class="col-span-2 font-medium">{{ item.label }}</label>
                                <input type="number" name="{{ item.name}}_q1" class="form-input" min="0" placeholder="Q1" step="0.01">
                                <input type="number" name="{{ item.name}}_q2" class="form-input" min="0" placeholder="Q2" step="0.01">
                                <input type="number" name="{{ item.name}}_q3" class="form-input" min="0" placeholder="Q3" step="0.01">
                                <input type="number" name="{{ item.name}}_q4" class="form-input" min="0" placeholder="Q4" step="0.01">
                                <input type="number" name="{{ item.name}}_total" class="form-input" min="0" placeholder="TOTAL" step="0.01">
                        </div>
                        {% endfor %}

                <!-- Professional Services Section -->
                <h3 class="text-lg font-semibold mb-1">Professional Services</h3>
                        {% for item in MOOE_professional_services %}
                        <div class="grid grid-cols-7 gap-4 items-center mb-2">
                                <label class="col-span-2 font-medium">{{ item.label }}</label>
                                <input type="number" name="{{ item.name }}_q1" class="form-input" min="0" placeholder="Q1" step="0.01">
                                <input type="number" name="{{ item.name }}_q2" class="form-input" min="0" placeholder="Q2" step="0.01">
                                <input type="number" name="{{ item.name }}_q3" class="form-input" min="0" placeholder="Q3" step="0.01">
                                <input type="number" name="{{ item.name }}_q4" class="form-input" min="0" placeholder="Q4" step="0.01">
                                <input type="number" name="{{ item.name }}_total" class="form-input" min="0" placeholder="TOTAL" step="0.01">
                        </div>
                        {% endfor %}

                <!-- General Services Section -->
                <h3 class="text-lg font-semibold mb-1">General Services</h3>
                    {% for item in MOOE_general_services %}
                    <div class="grid grid-cols-7 gap-4 items-center mb-2{% if forloop.last %} mb-4{% endif %}">
                            <label class="col-span-2 font-medium">{{ item.label }}</label>
                            <input type="number" name="{{ item.name }}_q1" class="form-input" min="0" placeholder="Q1" step="0.01">
                            <input type="number" name="{{ item.name }}_q2" class="form-input" min="0" placeholder="Q2" step="0.01">
                            <input type="number" name="{{ item.name }}_q3" class="form-input" min="0" placeholder="Q3" step="0.01">
                            <input type="number" name="{{ item.name }}_q4" class="form-input" min="0" placeholder="Q4" step="0.01">
                            <input type="number" name="{{ item.name }}_total" class="form-input" min="0" placeholder="TOTAL" step="0.01">
                    </div>
                    {% endfor %}
                
                <!-- Repair and Maintenance Section -->
                <h3 class="text-lg font-semibold mb-1">Repair and Maintenance</h3>
                    {% for item in repair_land_improvements %}
                    <div class="grid grid-cols-7 gap-4 items-center mb-4">
                            <label class="col-span-2 font-medium">{{ item.label }}</label>
                            <input type="number" name="{{ item.name }}_q1" class="form-input" min="0" placeholder="Q1" step="0.01">
                            <input type="number" name="{{ item.name }}_q2" class="form-input" min="0" placeholder="Q2" step="0.01">
                            <input type="number" name="{{ item.name }}_q3" class="form-input" min="0" placeholder="Q3" step="0.01">
                            <input type="number" name="{{ item.name }}_q4" class="form-input" min="0" placeholder="Q4" step="0.01">
                            <input type="number" name="{{ item.name }}_total" class="form-input" min="0" placeholder="TOTAL" step="0.01">
                    </div>
                    {% endfor %}

                <!-- Repair and Maintenance - Buildings and other Structures Section -->
                <h3 class="text-lg font-semibold mb-1">Repair and Maintenance - Buildings and other Structures</h3>
                    {% for item in repair_buildings_structures %}
                    <div class="grid grid-cols-7 gap-4 items-center {% if not forloop.last %}mb-2{% else %}mb-4{% endif %}">
                            <label class="col-span-2 font-medium">{{ item.label }}</label>
                            <input type="number" name="{{ item.name }}_q1" class="form-input" min="0" placeholder="Q1" step="0.01">
                            <input type="number" name="{{ item.name }}_q2" class="form-input" min="0" placeholder="Q2" step="0.01">
                            <input type="number" name="{{ item.name }}_q3" class="form-input" min="0" placeholder="Q3" step="0.01">
                            <input type="number" name="{{ item.name }}_q4" class="form-input" min="0" placeholder="Q4" step="0.01">
                            <input type="number" name="{{ item.name }}_total" class="form-input" min="0" placeholder="TOTAL" step="0.01">
                    </div>
                    {% endfor %}

                <!-- Repair and Maintenance - Buildings and other Structures Section -->
                <h3 class="text-lg font-semibold mb-1">Repair and Maintenance - Machinery and Equipment</h3>
                    {% for item in repair_machinery_equipment %}
                    <div class="grid grid-cols-7 gap-4 items-center {% if not forloop.last %}mb-2{% else %}mb-4{% endif %}">
                            <label class="col-span-2 font-medium">{{ item.label }}</label>
                            <input type="number" name="{{ item.name }}_q1" class="form-input" min="0" placeholder="Q1" step="0.01">
                            <input type="number" name="{{ item.name }}_q2" class="form-input" min="0" placeholder="Q2" step="0.01">
                            <input type="number" name="{{ item.name }}_q3" class="form-input" min="0" placeholder="Q3" step="0.01">
                            <input type="number" name="{{ item.name }}_q4" class="form-input" min="0" placeholder="Q4" step="0.01">
                            <input type="number" name="{{ item.name }}_total" class="form-input" min="0" placeholder="TOTAL" step="0.01">
                    </div>
                    {% endfor %}

                <!-- Repair and Maintenance - Buildings and other Structures Section -->
                <h3 class="text-lg font-semibold mb-1">Repairs and Maintenance - Transportation Equipment</h3>
                    {% for item in repair_transportation_equipment %}
                    <div class="grid grid-cols-7 gap-4 items-center mb-2">
                            <label class="col-span-2 font-medium">{{ item.label }}</label>
                            <input type="number" name="{{ item.name }}_q1" class="form-input" min="0" placeholder="Q1" step="0.01">
                            <input type="number" name="{{ item.name }}_q2" class="form-input" min="0" placeholder="Q2" step="0.01">
                            <input type="number" name="{{ item.name }}_q3" class="form-input" min="0" placeholder="Q3" step="0.01">
                            <input type="number" name="{{ item.name }}_q4" class="form-input" min="0" placeholder="Q4" step="0.01">
                            <input type="number" name="{{ item.name }}_total" class="form-input" min="0" placeholder="TOTAL" step="0.01">
                    </div>
                    {% endfor %}

                    {% for item in repair_furniture_fixtures %}
                    <div class="grid grid-cols-7 gap-4 items-center mb-2">
                            <label class="col-span-2 font-medium">{{ item.label }}</label>
                            <input type="number" name="{{ item.name }}_q1" class="form-input" min="0" placeholder="Q1" step="0.01">
                            <input type="number" name="{{ item.name }}_q2" class="form-input" min="0" placeholder="Q2" step="0.01">
                            <input type="number" name="{{ item.name }}_q3" class="form-input" min="0" placeholder="Q3" step="0.01">
                            <input type="number" name="{{ item.name }}_q4" class="form-input" min="0" placeholder="Q4" step="0.01">
                            <input type="number" name="{{ item.name }}_total" class="form-input" min="0" placeholder="TOTAL" step="0.01">
                    </div>
                    {% endfor %}

                    {% for item in repair_semi_expendable_me %}
                    <div class="grid grid-cols-7 gap-4 items-center mb-2">
                            <label class="col-span-2 font-medium">{{ item.label }}</label>
                            <input type="number" name="{{ item.name }}_q1" class="form-input" min="0" placeholder="Q1" step="0.01">
                            <input type="number" name="{{ item.name }}_q2" class="form-input" min="0" placeholder="Q2" step="0.01">
                            <input type="number" name="{{ item.name }}_q3" class="form-input" min="0" placeholder="Q3" step="0.01">
                            <input type="number" name="{{ item.name }}_q4" class="form-input" min="0" placeholder="Q4" step="0.01">
                            <input type="number" name="{{ item.name }}_total" class="form-input" min="0" placeholder="TOTAL" step="0.01">
                    </div>
                    {% endfor %}

                    {% for item in repair_other_property_plant_equipment %}
                    <div class="grid grid-cols-7 gap-4 items-center mb-4">
                            <label class="col-span-2 font-medium">{{ item.label }}</label>
                            <input type="number" name="{{ item.name }}_q1" class="form-input" min="0" placeholder="Q1" step="0.01">
                            <input type="number" name="{{ item.name }}_q2" class="form-input" min="0" placeholder="Q2" step="0.01">
                            <input type="number" name="{{ item.name }}_q3" class="form-input" min="0" placeholder="Q3" step="0.01">
                            <input type="number" name="{{ item.name }}_q4" class="form-input" min="0" placeholder="Q4" step="0.01">
                            <input type="number" name="{{ item.name }}_total" class="form-input" min="0" placeholder="TOTAL" step="0.01">
                    </div>
                    {% endfor %}

                <!-- Taxes, Insurance Premiums and Other FEES Section -->
                <h3 class="text-lg font-semibold mb-1">Taxes, Insurance Premiums and Other Fees</h3>
                    {% for item in taxes_insurance_fees %}
                    <div class="grid grid-cols-7 gap-4 items-center {% if not forloop.last %}mb-2{% else %}mb-4{% endif %}">
                            <label class="col-span-2 font-medium">{{ item.label }}</label>
                            <input type="number" name="{{ item.name }}_q1" class="form-input" min="0" placeholder="Q1" step="0.01">
                            <input type="number" name="{{ item.name }}_q2" class="form-input" min="0" placeholder="Q2" step="0.01">
                            <input type="number" name="{{ item.name }}_q3" class="form-input" min="0" placeholder="Q3" step="0.01">
                            <input type="number" name="{{ item.name }}_q4" class="form-input" min="0" placeholder="Q4" step="0.01">
                            <input type="number" name="{{ item.name }}_total" class="form-input" min="0" placeholder="TOTAL" step="0.01">
                    </div>
                    {% endfor %}

                <!-- Labor and Wages Section -->
                <h3 class="text-lg font-semibold mb-1">Labor and Wages</h3>
                    {% for item in labor_wages_list %}
                    <div class="grid grid-cols-7 gap-4 items-center mb-4">
                            <label class="col-span-2 font-medium">{{ item.label }}</label>
                            <input type="number" name="{{ item.name }}_q1" class="form-input" min="0" placeholder="Q1" step="0.01">
                            <input type="number" name="{{ item.name }}_q2" class="form-input" min="0" placeholder="Q2" step="0.01">
                            <input type="number" name="{{ item.name }}_q3" class="form-input" min="0" placeholder="Q3" step="0.01">
                            <input type="number" name="{{ item.name }}_q4" class="form-input" min="0" placeholder="Q4" step="0.01">
                            <input type="number" name="{{ item.name }}_total" class="form-input" min="0" placeholder="TOTAL" step="0.01">
                    </div>
                    {% endfor %}

                <!-- Other Maintenance & Operating Expenses Section -->
                <h3 class="text-lg font-semibold mb-1">Other Maintenance &amp; Operating Expenses</h3>
                    {% for item in other_mooe %}
                    <div class="grid grid-cols-7 gap-4 items-center {% if not forloop.last %}mb-2{% else %}mb-4{% endif %}">
                            <label class="col-span-2 font-medium">{{ item.label }}</label>
                            <input type="number" name="{{ item.name }}_q1" class="form-input" min="0" placeholder="Q1" step="0.01">
                            <input type="number" name="{{ item.name }}_q2" class="form-input" min="0" placeholder="Q2" step="0.01">
                            <input type="number" name="{{ item.name }}_q3" class="form-input" min="0" placeholder="Q3" step="0.01">
                            <input type="number" name="{{ item.name }}_q4" class="form-input" min="0" placeholder="Q4" step="0.01">
                            <input type="number" name="{{ item.name }}_total" class="form-input" min="0" placeholder="TOTAL" step="0.01">
                    </div>
                    {% endfor %}

                    <div class="grid grid-cols-7 gap-4 items-center mb-4">
                        <label class="col-span-2 font-bold underline">Total Maintenance and Other Operating Expenses</label>
                        <input class="border-gray-950 border-2" type="number" min="0" name="total_mooe_q1_total" class="form-input" placeholder="Q1 Total" step="0.01">
                        <input class="border-gray-950 border-2" type="number" min="0" name="total_mooe_q2_total" class="form-input" placeholder="Q2 Total" step="0.01">
                        <input class="border-gray-950 border-2" type="number" min="0" name="total_mooe_q3_total" class="form-input" placeholder="Q3 Total" step="0.01">
                        <input class="border-gray-950 border-2" type="number" min="0" name="total_mooe_q4_total" class="form-input" placeholder="Q4 Total" step="0.01">
                    </div>

            </div>


            <!-- Capital Outplays Section-->
            <div>
                <h2 class="text-xl font-bold mb-4">Capital Outplays</h2>
                <div class="mb-6 border-l-4 border-green-600 pl-4" data-category="capital">
                    <!-- Land Section -->
                    <h3 class="text-lg font-semibold mb-1">Land</h3>
                        {% for item in cap_land %}
                        <div class="grid grid-cols-7 gap-4 items-center mb-4">
                                <label class="col-span-2 font-medium">{{ item.label }}</label>
                                <input type="number" name="{{ item.name }}_q1" class="form-input" min="0" placeholder="Q1" step="0.01">
                                <input type="number" name="{{ item.name }}_q2" class="form-input" min="0" placeholder="Q2" step="0.01">
                                <input type="number" name="{{ item.name }}_q3" class="form-input" min="0" placeholder="Q3" step="0.01">
                                <input type="number" name="{{ item.name }}_q4" class="form-input" min="0" placeholder="Q4" step="0.01">
                                <input type="number" name="{{ item.name }}_total" class="form-input" min="0" placeholder="TOTAL" step="0.01">
                        </div>
                        {% endfor %}

                    <!-- Land Improvements Section -->
                    <h3 class="text-lg font-semibold mb-1">Land Improvements</h3>
                        {% for item in cap_land_improvements %}
                        <div class="grid grid-cols-7 gap-4 items-center mb-4">
                                <label class="col-span-2 font-medium">{{ item.label }}</label>
                                <input type="number" name="{{ item.name }}_q1" class="form-input" min="0" placeholder="Q1" step="0.01">
                                <input type="number" name="{{ item.name }}_q2" class="form-input" min="0" placeholder="Q2" step="0.01">
                                <input type="number" name="{{ item.name }}_q3" class="form-input" min="0" placeholder="Q3" step="0.01">
                                <input type="number" name="{{ item.name }}_q4" class="form-input" min="0" placeholder="Q4" step="0.01">
                                <input type="number" name="{{ item.name }}_total" class="form-input" min="0" placeholder="TOTAL" step="0.01">
                        </div>
                        {% endfor %}

                    <!-- Infrastructure Assets -->
                    <h3 class="text-lg font-semibold mb-1">Infrastructure Assets</h3>
                        {% for item in cap_infrastructure_assets %}
                        <div class="grid grid-cols-7 gap-4 items-center {% if not forloop.last %}mb-2{% else %}mb-4{% endif %}">
                                <label class="col-span-2 font-medium">{{ item.label }}</label>
                                <input type="number" name="{{ item.name }}_q1" class="form-input" min="0" placeholder="Q1" step="0.01">
                                <input type="number" name="{{ item.name }}_q2" class="form-input" min="0" placeholder="Q2" step="0.01">
                                <input type="number" name="{{ item.name }}_q3" class="form-input" min="0" placeholder="Q3" step="0.01">
                                <input type="number" name="{{ item.name }}_q4" class="form-input" min="0" placeholder="Q4" step="0.01">
                                <input type="number" name="{{ item.name }}_total" class="form-input" min="0" placeholder="TOTAL" step="0.01">
                        </div>
                        {% endfor %}

                    <!-- Building and Other Structures (BOS) Section -->
                    <h3 class="text-lg font-semibold mb-1">Building and Other Structures</h3>
                        {% for item in cap_bos %}
                        <div class="grid grid-cols-7 gap-4 items-center {% if not forloop.last %}mb-2{% else %}mb-4{% endif %}">
                                <label class="col-span-2 font-medium">{{ item.label }}</label>
                                <input type="number" name="{{ item.name }}_q1" class="form-input" min="0" placeholder="Q1" step="0.01">
                                <input type="number" name="{{ item.name }}_q2" class="form-input" min="0" placeholder="Q2" step="0.01">
                                <input type="number" name="{{ item.name }}_q3" class="form-input" min="0" placeholder="Q3" step="0.01">
                                <input type="number" name="{{ item.name }}_q4" class="form-input" min="0" placeholder="Q4" step="0.01">
                                <input type="number" name="{{ item.name }}_total" class="form-input" min="0" placeholder="TOTAL" step="0.01">
                        </div>
                        {% endfor %}

                    <!-- Machinery and Equipment (ME) Section -->
                    <h3 class="text-lg font-semibold mb-1">Machinery and Equipment</h3>
                        {% for item in cap_me %}
                        <div class="grid grid-cols-7 gap-4 items-center {% if not forloop.last %}mb-2{% else %}mb-4{% endif %}">
                                <label class="col-span-2 font-medium">{{ item.label }}</label>
                                <input type="number" name="{{ item.name }}_q1" class="form-input" min="0" placeholder="Q1" step="0.01">
                                <input type="number" name="{{ item.name }}_q2" class="form-input" min="0" placeholder="Q2" step="0.01">
                                <input type="number" name="{{ item.name }}_q3" class="form-input" min="0" placeholder="Q3" step="0.01">
                                <input type="number" name="{{ item.name }}_q4" class="form-input" min="0" placeholder="Q4" step="0.01">
                                <input type="number" name="{{ item.name }}_total" class="form-input" min="0" placeholder="TOTAL" step="0.01">
                        </div>
                        {% endfor %}

                    <!-- Transportation Equipment (TE) Section -->
                    <h3 class="text-lg font-semibold mb-1">Transportation Equipment</h3>
                        {% for item in cap_te %}
                        <div class="grid grid-cols-7 gap-4 items-center {% if not forloop.last %}mb-2{% else %}mb-4{% endif %}">
                                <label class="col-span-2 font-medium">{{ item.label }}</label>
                                <input type="number" name="{{ item.name }}_q1" class="form-input" min="0" placeholder="Q1" step="0.01">
                                <input type="number" name="{{ item.name }}_q2" class="form-input" min="0" placeholder="Q2" step="0.01">
                                <input type="number" name="{{ item.name }}_q3" class="form-input" min="0" placeholder="Q3" step="0.01">
                                <input type="number" name="{{ item.name }}_q4" class="form-input" min="0" placeholder="Q4" step="0.01">
                                <input type="number" name="{{ item.name }}_total" class="form-input" min="0" placeholder="TOTAL" step="0.01">
                        </div>
                        {% endfor %}
                
                     <!-- Furniture, Fixtures and Books Section -->
                    <h3 class="text-lg font-semibold mb-1">Furniture, Fixtures and Books</h3>
                        {% for item in cap_ffb %}
                        <div class="grid grid-cols-7 gap-4 items-center {% if not forloop.last %}mb-2{% else %}mb-4{% endif %}">
                                <label class="col-span-2 font-medium">{{ item.label }}</label>
                                <input type="number" name="{{ item.name }}_q1" class="form-input" min="0" placeholder="Q1" step="0.01">
                                <input type="number" name="{{ item.name }}_q2" class="form-input" min="0" placeholder="Q2" step="0.01">
                                <input type="number" name="{{ item.name }}_q3" class="form-input" min="0" placeholder="Q3" step="0.01">
                                <input type="number" name="{{ item.name }}_q4" class="form-input" min="0" placeholder="Q4" step="0.01">
                                <input type="number" name="{{ item.name }}_total" class="form-input" min="0" placeholder="TOTAL" step="0.01">
                        </div>
                        {% endfor %}

                     <!-- Construction in Progress Section -->
                    <h3 class="text-lg font-semibold mb-1">Construction in Progress</h3>
                        {% for item in cap_cp %}
                        <div class="grid grid-cols-7 gap-4 items-center {% if not forloop.last %}mb-2{% else %}mb-4{% endif %}">
                                <label class="col-span-2 font-medium">{{ item.label }}</label>
                                <input type="number" name="{{ item.name }}_q1" class="form-input" min="0" placeholder="Q1" step="0.01">
                                <input type="number" name="{{ item.name }}_q2" class="form-input" min="0" placeholder="Q2" step="0.01">
                                <input type="number" name="{{ item.name }}_q3" class="form-input" min="0" placeholder="Q3" step="0.01">
                                <input type="number" name="{{ item.name }}_q4" class="form-input" min="0" placeholder="Q4" step="0.01">
                                <input type="number" name="{{ item.name }}_total" class="form-input" min="0" placeholder="TOTAL" step="0.01">
                        </div>
                        {% endfor %}

                    <!-- Intangible Asset (IA) Section -->
                    <h3 class="text-lg font-semibold mb-1">Intangible Asset</h3>
                        {% for item in cap_ia %}
                        <div class="grid grid-cols-7 gap-4 items-center {% if not forloop.last %}mb-2{% else %}mb-4{% endif %}">
                                <label class="col-span-2 font-medium">{{ item.label }}</label>
                                <input type="number" name="{{ item.name }}_q1" class="form-input" min="0" placeholder="Q1" step="0.01">
                                <input type="number" name="{{ item.name }}_q2" class="form-input" min="0" placeholder="Q2" step="0.01">
                                <input type="number" name="{{ item.name }}_q3" class="form-input" min="0" placeholder="Q3" step="0.01">
                                <input type="number" name="{{ item.name }}_q4" class="form-input" min="0" placeholder="Q4" step="0.01">
                                <input type="number" name="{{ item.name }}_total" class="form-input" min="0" placeholder="TOTAL" step="0.01">
                        </div>
                        {% endfor %}

                        <div class="grid grid-cols-7 gap-4 items-center mb-4">
                                <label class="col-span-2 font-bold underline">Total Capital Outplays</label>
                                <input class="border-gray-950 border-2" type="number" min="0" name="total_capital_outplays_q1_total" class="form-input" placeholder="Q1 Total" step="0.01">
                                <input class="border-gray-950 border-2" type="number" min="0" name="total_capital_outplays_q2_total" class="form-input" placeholder="Q2 Total" step="0.01">
                                <input class="border-gray-950 border-2" type="number" min="0" name="total_capital_outplays_q3_total" class="form-input" placeholder="Q3 Total" step="0.01">
                                <input class="border-gray-950 border-2" type="number" min="0" name="total_capital_outplays_q4_total" class="form-input" placeholder="Q4 Total" step="0.01">
                        </div>
                </div>
            </div>

        </section>

        <div class="mt-8">
            <h3 class="text-lg font-bold text-[1.5rem] mb-2">Total</h3>
            <div class="grid grid-cols-7 gap-4 ml-[1.7rem]">
                <div class="col-span-2"></div>
                <input type="text" readonly name="total_q1" class="form-input bg-gray-100" placeholder="Q1 Total">
                <input type="text" readonly name="total_q2" class="form-input bg-gray-100" placeholder="Q2 Total">
                <input type="text" readonly name="total_q3" class="form-input bg-gray-100" placeholder="Q3 Total">
                <input type="text" readonly name="total_q4" class="form-input bg-gray-100" placeholder="Q4 Total">
            </div>
        </div>

        <!-- === Summary Section === -->
        <div class="mt-12 border-t pt-8">
            <h3 class="text-xl font-bold mb-4">Summary of Totals</h3>
            <div class="grid grid-cols-2 gap-6 mb-4">
                <div>
                    <label class="block font-medium">Total Personnel Services</label>
                    <input type="text" readonly name="summary_total_personnel" class="form-input bg-gray-100 w-full">
                </div>
                <div>
                    <label class="block font-medium">Total MOOE</label>
                    <input type="text" readonly name="summary_total_mooe" class="form-input bg-gray-100 w-full">
                </div>
                <div>
                    <label class="block font-medium">Total Capital Outlay</label>
                    <input type="text" readonly name="summary_total_capital" class="form-input bg-gray-100 w-full">
                </div>
                <div>
                    <label class="block font-medium">Grand Total</label>
                    <input type="text" readonly name="summary_grand_total" class="form-input bg-gray-100 w-full">
                </div>
                <div>
                    <label class="block font-medium">Procureable</label>
                    <input type="text" name="summary_procureable" class="form-input w-full">
                </div>
                <div>
                    <label class="block font-medium">Non-Procureable</label>
                    <input type="text" name="summary_non_procureable" class="form-input w-full">
                </div>
            </div>
        </div>

        <!-- === Certification Section === -->
        <div class="mt-12">
            <h3 class="text-xl font-bold mb-4">Certification</h3>
            <div class="grid grid-cols-3 gap-10 mt-6">
                <div>
                    <p class="font-medium mb-2">Prepared by:</p>
                    <input type="text" name="prepared_by" class="form-input w-full">
                </div>
                <div>
                    <p class="font-medium mb-2">Certified as to availability of funds:</p>
                    <input type="text" name="certified_by" class="form-input w-full">
                </div>
                <div>
                    <p class="font-medium mb-2">Approved:</p>
                    <input type="text" name="approved_by" class="form-input w-full">
                </div>
            </div>
        </div>

        <!-- Hidden summary total for backend -->
        <input type="hidden" name="summary_grand_total_value" value="">

        <!-- Submit -->
        <div class="mt-10">
            <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg">
                Submit PRE
            </button>
        </div>
    </form>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
            <h3 class="text-lg font-semibold mb-2">Confirm Submission</h3>
            <p class="text-sm text-gray-600 mb-6">Are you sure you want to submit this PRE? Please review your totals before proceeding.</p>
            <div class="flex items-center justify-end gap-3">
                <button type="button" id="cancelConfirmBtn" class="px-4 py-2 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-50">Cancel</button>
                <button type="button" id="proceedSubmitBtn" class="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">Yes, submit</button>
            </div>
        </div>
    </div>

    {% if messages %}
    <!-- Messages Modal -->
    <div id="messageModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
            <h3 class="text-lg font-semibold mb-3">Notice</h3>
            <div class="space-y-2 text-sm">
                {% for message in messages %}
                    <div class="px-3 py-2 rounded {{ message.tags|default:'' }} {% if 'success' in message.tags %}bg-green-50 text-green-700 border border-green-200{% elif 'error' in message.tags %}bg-red-50 text-red-700 border border-red-200{% else %}bg-gray-50 text-gray-700 border border-gray-200{% endif %}">{{ message }}</div>
                {% endfor %}
            </div>
            <div class="mt-6 text-right">
                <form action="{% url "preview_pre" pre_id %}" method="get">
                <button type="submit" id="closeMessageBtn" class="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">OK</button>
                </form>
            </div>
        </div>
    </div>
    {% endif %}
</main>

<script>
(function() {
  const form = document.getElementById('preForm');
  if (!form) return;

  const confirmModal = document.getElementById('confirmModal');
  const proceedBtn = document.getElementById('proceedSubmitBtn');
  const cancelBtn = document.getElementById('cancelConfirmBtn');
  const messageModal = document.getElementById('messageModal');
  const closeMessageBtn = document.getElementById('closeMessageBtn');

  // Utility helpers
  const show = el => { if (el) { el.classList.remove('hidden'); el.classList.add('flex'); } };
  const hide = el => { if (el) { el.classList.add('hidden'); el.classList.remove('flex'); } };
  const toNumber = v => {
    if (v === null || v === undefined) return 0;
    const n = parseFloat(('' + v).replace(/,/g, ''));
    return isNaN(n) ? 0 : n;
  };
  const fmt = n => {
    try { return (Math.round(n * 100) / 100).toFixed(2); } catch(e) { return '0.00'; }
  };

  // Inputs for summary totals
  const summary = {
    personnel: form.querySelector('input[name="summary_total_personnel"]'),
    mooe: form.querySelector('input[name="summary_total_mooe"]'),
    capital: form.querySelector('input[name="summary_total_capital"]'),
    grand: form.querySelector('input[name="summary_grand_total"]'),
    procureable: form.querySelector('input[name="summary_procureable"]'),
    nonProcureable: form.querySelector('input[name="summary_non_procureable"]'),
    grandHidden: form.querySelector('input[name="summary_grand_total_value"]'),
  };

  // Category wrappers
  const catEls = {
    personnel: document.querySelector('[data-category="personnel"]'),
    mooe: document.querySelector('[data-category="mooe"]'),
    capital: document.querySelector('[data-category="capital"]'),
  };

  // Category total fields
  const catTotalFields = {
    personnel: {
      q1: form.querySelector('input[name="total_personnel_q1_total"]'),
      q2: form.querySelector('input[name="total_personnel_q2_total"]'),
      q3: form.querySelector('input[name="total_personnel_q3_total"]'),
      q4: form.querySelector('input[name="total_personnel_q4_total"]')
    },
    mooe: {
      q1: form.querySelector('input[name="total_mooe_q1_total"]'),
      q2: form.querySelector('input[name="total_mooe_q2_total"]'),
      q3: form.querySelector('input[name="total_mooe_q3_total"]'),
      q4: form.querySelector('input[name="total_mooe_q4_total"]')
    },
    capital: {
      q1: form.querySelector('input[name="total_capital_outplays_q1_total"]'),
      q2: form.querySelector('input[name="total_capital_outplays_q2_total"]'),
      q3: form.querySelector('input[name="total_capital_outplays_q3_total"]'),
      q4: form.querySelector('input[name="total_capital_outplays_q4_total"]')
    }
  };

  // Bottom total row fields
  const bottomTotals = {
    q1: form.querySelector('input[name="total_q1"]'),
    q2: form.querySelector('input[name="total_q2"]'),
    q3: form.querySelector('input[name="total_q3"]'),
    q4: form.querySelector('input[name="total_q4"]'),
  };

  function calcCategorySums(catEl) {
    const sums = { q1: 0, q2: 0, q3: 0, q4: 0 };
    if (!catEl) return sums;
    const inputs = catEl.querySelectorAll('input[type="number"]');
    inputs.forEach(inp => {
      const name = inp.name || '';
      // Skip the category total fields themselves (end with _q{n}_total)
      if (/_(q1|q2|q3|q4)_total$/.test(name)) return;
      // Include only the quarter-specific inputs (end with _q{n})
      const m = name.match(/_(q1|q2|q3|q4)$/);
      if (!m) return;
      const key = m[1];
      sums[key] += toNumber(inp.value);
    });
    return sums;
  }

  function recompute() {
    // Per-category Q totals
    const p = calcCategorySums(catEls.personnel);
    const m = calcCategorySums(catEls.mooe);
    const c = calcCategorySums(catEls.capital);

    // Fill category total fields
    if (catTotalFields.personnel.q1) catTotalFields.personnel.q1.value = fmt(p.q1);
    if (catTotalFields.personnel.q2) catTotalFields.personnel.q2.value = fmt(p.q2);
    if (catTotalFields.personnel.q3) catTotalFields.personnel.q3.value = fmt(p.q3);
    if (catTotalFields.personnel.q4) catTotalFields.personnel.q4.value = fmt(p.q4);

    if (catTotalFields.mooe.q1) catTotalFields.mooe.q1.value = fmt(m.q1);
    if (catTotalFields.mooe.q2) catTotalFields.mooe.q2.value = fmt(m.q2);
    if (catTotalFields.mooe.q3) catTotalFields.mooe.q3.value = fmt(m.q3);
    if (catTotalFields.mooe.q4) catTotalFields.mooe.q4.value = fmt(m.q4);

    if (catTotalFields.capital.q1) catTotalFields.capital.q1.value = fmt(c.q1);
    if (catTotalFields.capital.q2) catTotalFields.capital.q2.value = fmt(c.q2);
    if (catTotalFields.capital.q3) catTotalFields.capital.q3.value = fmt(c.q3);
    if (catTotalFields.capital.q4) catTotalFields.capital.q4.value = fmt(c.q4);

    // Bottom total row
    const total = {
      q1: p.q1 + m.q1 + c.q1,
      q2: p.q2 + m.q2 + c.q2,
      q3: p.q3 + m.q3 + c.q3,
      q4: p.q4 + m.q4 + c.q4,
    };
    if (bottomTotals.q1) bottomTotals.q1.value = fmt(total.q1);
    if (bottomTotals.q2) bottomTotals.q2.value = fmt(total.q2);
    if (bottomTotals.q3) bottomTotals.q3.value = fmt(total.q3);
    if (bottomTotals.q4) bottomTotals.q4.value = fmt(total.q4);

    // Category grand totals
    const gPersonnel = p.q1 + p.q2 + p.q3 + p.q4;
    const gMooe = m.q1 + m.q2 + m.q3 + m.q4;
    const gCapital = c.q1 + c.q2 + c.q3 + c.q4;
    const gAll = gPersonnel + gMooe + gCapital;

    if (summary.personnel) summary.personnel.value = fmt(gPersonnel);
    if (summary.mooe) summary.mooe.value = fmt(gMooe);
    if (summary.capital) summary.capital.value = fmt(gCapital);
    if (summary.grand) summary.grand.value = fmt(gAll);
    if (summary.grandHidden) summary.grandHidden.value = fmt(gAll);

    // Procurable / Non-procurable split
    // Assumption: Procurable = MOOE + Capital; Non-Procureable = Personnel
    if (summary.procureable) summary.procureable.value = fmt(gMooe + gCapital);
    if (summary.nonProcureable) summary.nonProcureable.value = fmt(gPersonnel);
  }

  // Live recompute on any number input changes
  form.addEventListener('input', function(e) {
    const t = e.target;
    if (t && t.tagName === 'INPUT' && t.type === 'number') {
      recompute();
    }
  });

  // Initial compute
  recompute();

  // Confirmation flow: intercept default submit
  form.addEventListener('submit', function(e) {
    // Let htmx-enhanced programmatic submission handle flow
    e.preventDefault();
    recompute();
    show(confirmModal);
  });

  if (cancelBtn) cancelBtn.addEventListener('click', function() { hide(confirmModal); });
  if (proceedBtn) proceedBtn.addEventListener('click', function() {
    hide(confirmModal);
    // If HTMX is present and used on this form, submit via HTMX; else normal submit
    if (window.htmx && typeof htmx.submit === 'function' && (form.hasAttribute('hx-post') || form.hasAttribute('hx-put') || form.hasAttribute('hx-patch'))) {
      htmx.submit(form);
    } else {
      // Use native submit without triggering submit handlers again
      HTMLFormElement.prototype.submit.call(form);
    }
    
  });

  // Auto-open message modal when there are messages
  if (messageModal) {
    show(messageModal);
    if (closeMessageBtn) closeMessageBtn.addEventListener('click', function() { hide(messageModal); });
    // Close when clicking overlay
    messageModal.addEventListener('click', function(e) { if (e.target === messageModal) hide(messageModal); });
  }
})();
</script>
{% endblock %}
