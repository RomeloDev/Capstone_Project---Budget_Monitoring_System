{% extends "end_user_base_template/dashboard.html" %}

{% load humanize %}

{% block title %}
    Purchase Request Form
{% endblock title %}

{% block main-content %}
    <main class="mx-auto max-w-5xl p-4 md:p-8">
        <!-- Header / Masthead -->
        <section class="mb-6 rounded-lg bg-white p-4 shadow-sm ring-1 ring-gray-200">
            <div class="flex flex-col items-center justify-between gap-4 text-center md:flex-row md:text-left">
                <div class="flex items-center gap-4">
                    <div class="h-14 w-14 rounded-full bg-gray-100 ring-1 ring-gray-200">
                        <img src="https://bisu.edu.ph/wp-content/themes/gwt-wordpress-gwt-wordpress-26.0.0/images/bisu-logo2.png" 
                             alt="Bisu Logo" 
                             class="h-full w-full object-cover rounded-full">
                    </div>
                    <div>
                        <p class="text-xs uppercase tracking-wider text-gray-500">Republic of the Philippines</p>
                        <h1 class="text-lg font-semibold">Bohol Island State University</h1>
                        <p class="text-xs text-gray-500">Magsija, Balilihan, Bohol, Philippines</p>
                        <p class="text-[11px] text-gray-500">Office of the __________</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 rounded bg-gray-100 ring-1 ring-gray-200">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/b/b1/Bagong_Pilipinas_logo.png" alt="Bagong Pilipinas Logo">
                    </div>
                    <div class="h-10 w-20 rounded bg-gray-100 ring-1 ring-gray-200">
                        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQyAcSvFonC-PFbOnMUYYjRlVgb9fNbgt_lFw&s" alt="ISO Logo">
                    </div>
                </div>
            </div>
            <div class="mt-4 border-t pt-3 text-center">
                <h2 class="text-xl font-bold tracking-wide">PURCHASE REQUEST</h2>
            </div>
        </section>

        <!-- Actions -->
        <div class="no-print mb-4 flex flex-wrap items-center gap-2">
            <button type="reset" form="main-pr-form" class="rounded-md bg-white px-3 py-2 text-sm font-medium text-gray-700 ring-1 ring-gray-300 hover:bg-gray-200">Reset</button>
            <button type="button" onclick="openConfirmModal()" class="rounded-md bg-green-600 px-3 py-2 text-sm font-medium text-white hover:bg-green-700">Submit</button>
        </div>

        <!-- Form -->
        <form id="main-pr-form" action="{% url "purchase_request_form" %}" method="post" class="space-y-4" hx-post="{% url 'purchase_request_form' %}" hx-swap="none" hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
            {% csrf_token %}

            <!-- Request Details -->
            <section class="card rounded-lg bg-white p-4 shadow-sm ring-1 ring-gray-200">
                <h3 class="mb-3 text-base font-semibold">Request Details</h3>
                <div class="grid gap-4 md:grid-cols-2">
                    <div>
                        <label for="entity_name" class="mb-1 block text-sm font-medium">Entity Name</label>
                        <input type="text" id="entity_name" name="entity_name" required class="w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="fund_cluster" class="mb-1 block text-sm font-medium">Fund Cluster</label>
                        <input type="text" id="fund_cluster" name="fund_cluster" required class="w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="office_section" class="mb-1 block text-sm font-medium">Office/Section</label>
                        <input type="text" id="office_section" name="office_section" required class="w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="pr_no" class="mb-1 block text-sm font-medium">PR No.</label>
                        <input type="text" id="pr_no" name="pr_no" required class="w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div class="md:col-span-2">
                        <label for="responsibility_code" class="mb-1 block text-sm font-medium">Responsibility Center Code</label>
                        <input type="text" id="responsibility_code" name="responsibility_code" required class="w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500">
                    </div>
                </div>
            </section>

            <!-- Funding Details -->
            <section class="card rounded-lg bg-white p-4 shadow-sm ring-1 ring-gray-200">
                <h3 class="mb-3 text-base font-semibold">Funding Details</h3>
                <div class="grid gap-4 md:grid-cols-2">
                    <div>
                        <!-- Budget Allocation -->
                        <label for="budget_allocation" class="mb-1 block text-sm font-medium">Budget Allocation</label>
                        <select 
                            name="budget_allocation" 
                            id="budget_allocation"
                            class="form-select w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500"
                            hx-get="{% url 'load_source_of_fund' %}" 
                            hx-target="#source_of_fund_container"
                            hx-trigger="change"
                            hx-include="[name=csrfmiddlewaretoken]"  
                            hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                            hx-swap="innerHTML"
                            required
                        >
                            <option value="">Select Budget Allocation</option>
                            {% for alloc in budget_allocations %}
                                <option value="{{ alloc.id }}">
                                    {{ alloc.approved_budget.title }} - {{ alloc.approved_budget.period }} - {{ alloc.total_allocated|intcomma }}
                                </option>
                            {% empty %}
                                <option disabled>No allocations found</option>
                            {% endfor %}
                        </select>


                        {% comment %} <label for="budget_allocation" class="mb-1 block text-sm font-medium">Budget Allocation</label>
                        <select id="budget_allocation" name="budget_allocation" class="w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500">
                            <option disabled selected>Select Budget Allocation</option>
                            {% for alloc in budget_allocations %}
                                <option value="{{ alloc.id }}">{{ alloc.approved_budget.title }} - {{ alloc.approved_budget.period }} - {{ alloc.total_allocated|intcomma }}</option>
                            {% empty %}
                                <option disabled>No allocations found</option>
                            {% endfor %}
                        </select> {% endcomment %}
                    </div>
                    {% comment %} <div>
                        <label for="source_of_fund" class="mb-1 block text-sm font-medium">Source of Fund</label>
                        <div class="relative">
                            <input type="text" id="sof_search" name="sof_search" autocomplete="off"
                                placeholder="Search Source of Fund..." 
                                class="w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500"
                                oninput="showSofSuggestions(this.value)">
                            <input type="hidden" id="source_of_fund" name="source_of_fund">
                            <ul id="sof_suggestions" class="absolute z-10 w-full bg-white border border-gray-200 rounded-md shadow-lg max-h-40 overflow-auto hidden"></ul>
                        </div>
                    </div> {% endcomment %}
                    <div>
                        <!-- Source of Fund -->
                        <label for="source_of_fund" class="mb-1 block text-sm font-medium">Source of Fund</label>
                        <div id="source_of_fund_container">
                            <input type="search" id="sof_search" placeholder="Search..." class="mb-2 w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500" oninput="filterSofOptions()" />
                            <select name="source_of_fund" id="source_of_fund" class="form-select w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500" required>
                                <option value="">Select Source of Fund</option>
                                {% for opt in source_of_fund_options %}
                                    <option value="{{ opt.value }}">{{ opt.label }}</option>
                                {% empty %}
                                    <option disabled>No approved PRE funds available</option>
                                {% endfor %}
                            </select>
                        </div>

                        {% comment %} <label for="source_of_fund" class="mb-1 block text-sm font-medium">Source of Fund</label>
                        <div class="relative">
                            <input type="search" id="sof_search" placeholder="Search..." class="mb-2 w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500" oninput="filterSofOptions()" />
                            <select id="source_of_fund" name="source_of_fund" class="w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500">
                                <option disabled selected>Select Source of Fund</option>
                                {% for opt in source_of_fund_options %}
                                    <option value="{{ opt.value }}">{{ opt.label }}</option>
                                {% empty %}
                                    <option disabled>No approved PRE funds available</option>
                                {% endfor %}
                            </select>
                        </div> {% endcomment %}
                    </div> 
                </div>
            </section>

            <!-- Items Requested -->
            <section class="card rounded-lg bg-white p-4 shadow-sm ring-1 ring-gray-200">
                <div class="mb-3 flex items-center justify-between">
                    <h3 class="text-base font-semibold">Items Requested</h3>
                </div>
                <div class="overflow-x-auto rounded-lg border border-gray-200">
                    <table class="min-w-full text-left text-sm">
                        <thead class="bg-gray-50 text-xs uppercase text-gray-600 border-b border-gray-200">
                            <tr>
                                <th class="px-3 py-2">Stock/Property No</th>
                                <th class="px-3 py-2">Unit</th>
                                <th class="px-3 py-2">Item Description</th>
                                <th class="px-3 py-2">Quantity</th>
                                <th class="px-3 py-2">Unit Cost</th>
                                <th class="px-3 py-2">Total Cost</th>
                                <th class="px-3 py-2">Action</th>
                            </tr>
                        </thead>
                        <tbody id="items-table-body" class="divide-y divide-gray-200">
                            {% for item in purchase_items %}
                                <tr id="item-{{ item.id }}">
                                    <td class="px-3 py-2">{{ item.stock_property_no }}</td>
                                    <td class="px-3 py-2">{{ item.unit }}</td>
                                    <td class="px-3 py-2">{{ item.item_description }}</td>
                                    <td class="px-3 py-2">{{ item.quantity }}</td>
                                    <td class="px-3 py-2">&#8369; {{ item.unit_cost|intcomma }}</td>
                                    <td class="px-3 py-2">&#8369; {{ item.total_cost|intcomma }}</td>
                                    <td class="px-3 py-2">
                                        <button 
                                            type="button" 
                                            class="focus:outline-none text-white bg-red-700 hover:bg-red-800 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-[12px] px-3 py-1 me-2 mb-2 dark:bg-red-600 dark:hover:bg-red-700 dark:focus:ring-red-900"
                                            hx-delete="{% url "remove_purchase_item" item.id %}"
                                            hx-target="#item-{{ item.id }}"
                                            hx-swap="outerHTML"
                                            hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
                                            Remove Item
                                        </button>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                            <!-- Input Row -->
                            <tr id="input-row" class="bg-gray-50">
                                <td class="px-3 py-2"><input type="text" name="stock_no" id="stock_no" class="w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500"></td>
                                <td class="px-3 py-2"><input type="text" name="unit" id="unit" class="w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500"></td>
                                <td class="px-3 py-2"><input type="text" name="item_desc" id="item_desc" class="w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500"></td>
                                <td class="px-3 py-2"><input type="number" name="quantity" id="quantity" min="0" class="w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500"></td>
                                <td class="px-3 py-2"><input type="number" name="unit_cost" id="unit_cost" min="0" class="w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500"></td>
                                <td class="px-3 py-2 text-gray-500">Auto Calculated</td>
                                <td class="px-3 py-2"></td>
                            </tr>
                            <!-- Total Row -->
                            <tr id="total-amount-row" class="font-semibold">
                                <td colspan="5" class="px-3 py-2 text-right">Total Amount</td>
                                <td class="px-3 py-2">&#8369; {{ purchase_request.total_amount|intcomma }}</td>
                                <td></td>
                            </tr>
                        
                    </table>
                </div>
                <div class="no-print mt-3">
                    <button 
                        type="button" 
                        id="add-item"
                        class="inline-flex items-center gap-2 rounded-md bg-blue-600 px-3 py-1.5 text-sm font-medium text-gray-50 ring-1 ring-gray-300 hover:bg-blue-800"
                        hx-post="{% url "add_purchase_item" %}"
                        hx-target="#items-table-body"
                        hx-swap="beforeend"
                        hx-include="tr#input-row input"
                        hx-trigger="click"
                        hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                        hx-on::after-request="document.querySelectorAll('#input-row input').forEach(input => input.value = '')">
                        + Add Item
                    </button>
                </div>
            </section>

            <!-- Purpose -->
            <section class="card rounded-lg bg-white p-4 shadow-sm ring-1 ring-gray-200">
                <h3 class="mb-3 text-base font-semibold">Purpose</h3>
                <label for="purpose" class="mb-1 block text-sm font-medium">State purpose of the purchase</label>
                <textarea id="purpose" name="purpose" rows="3" class="auto-resize w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500"></textarea>
            </section>

            {% if messages %}
                <section class="rounded-lg bg-white p-3 shadow-sm ring-1 ring-gray-200">
                    {% for message in messages %}
                        <p class="text-center text-[1.2rem] mt-2 font-medium 
                            {% if message.tags == 'success' %}
                                text-green-600
                            {% elif message.tags == 'error' %}
                                text-red-600
                            {% else %}
                                text-gray-700
                            {% endif %}
                        ">
                            {{ message }}
                        </p>
                    {% endfor %}
                </section>
            {% endif %}
        </form>
    </main>

    <!-- Confirmation Modal -->
    <div id="submit-confirm-modal" class="fixed inset-0 hidden items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h3 class="text-lg font-semibold mb-4">Confirm Submission</h3>
            <p class="text-gray-600 mb-6">Are you sure you want to submit this Purchase Request?</p>
            <div class="flex justify-end gap-3">
                <button class="px-4 py-2 bg-gray-200 rounded-md" onclick="closeConfirmModal()">Cancel</button>
                <button class="px-4 py-2 bg-indigo-600 text-white rounded-md" onclick="submitPrForm()">Yes, Submit</button>
            </div>
        </div>
    </div>

    <!-- Success Modal (replaced on submit via htmx) -->
    <div id="submit-success-modal" class="hidden"></div>

    <script>
        // Confirm modal helpers
        function openConfirmModal() {
            document.getElementById('submit-confirm-modal').classList.remove('hidden');
            document.getElementById('submit-confirm-modal').classList.add('flex');
        }
        function closeConfirmModal() {
            document.getElementById('submit-confirm-modal').classList.add('hidden');
            document.getElementById('submit-confirm-modal').classList.remove('flex');
        }
        function submitPrForm() {
            closeConfirmModal();
            // Trigger htmx submission on the form
            document.getElementById('main-pr-form').dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
        }

        // Auto-resize textareas (match activity_design_form style)
        const autoResize = (el) => {
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
        };
        document.querySelectorAll('.auto-resize').forEach(t => {
            autoResize(t);
            t.addEventListener('input', () => autoResize(t));
        });

        // Source of Fund search filter
        function filterSofOptions() {
            const query = document.getElementById('sof_search').value.toLowerCase();
            const select = document.getElementById('source_of_fund');
            for (const option of select.options) {
                if (!option.value) continue;
                option.hidden = !option.text.toLowerCase().includes(query);
            }
        }

        // Listen for htmx response and show success with redirect
        document.body.addEventListener('htmx:afterRequest', function(evt) {
            try {
                const xhr = evt.detail.xhr;
                const data = JSON.parse(xhr.responseText || '{}');
                if (data && data.success === false) {
                    showErrorMessage(data.error);
                }
                else if (data && data.success) {
                    const modal = document.getElementById('submit-success-modal');
                    modal.classList.remove('hidden');
                    modal.innerHTML = `
                        <div class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50">
                            <div class="bg-white rounded-lg p-6 w-full max-w-md">
                                <h3 class="text-lg font-semibold mb-4">Purchase Request Submitted Successfully</h3>
                                <p class="text-gray-600 mb-6">Redirecting to previewâ€¦</p>
                            </div>
                        </div>`;
                    setTimeout(() => { window.location.href = data.redirect_url; }, 1200);
                }
            } catch (e) {
                // not JSON, ignore
            }
        });

        function showErrorMessage(message) {
        // Create or update error display
        let errorDiv = document.getElementById('budget-error-message');
        if (!errorDiv) {
            errorDiv = document.createElement('div');
            errorDiv.id = 'budget-error-message';
            errorDiv.className = 'rounded-lg bg-red-50 p-4 mb-4 border border-red-200';
            
            // Insert after the form header
            const form = document.getElementById('main-pr-form');
            form.insertBefore(errorDiv, form.firstChild);
        }
        
        errorDiv.innerHTML = `
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-red-800">Budget Validation Error</h3>
                    <div class="mt-2 text-sm text-red-700">
                        <p>${message}</p>
                    </div>
                </div>
            </div>
        `;
        
        // Scroll to error message
        errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

        // Example: Replace this with your actual options from Django context
        const sofOptions = [
            {% for opt in source_of_fund_options %}
                { value: "{{ opt.value }}", label: "{{ opt.label }}" },
            {% endfor %}
        ];

        function showSofSuggestions(query) {
            const suggestions = document.getElementById('sof_suggestions');
            const input = document.getElementById('sof_search');
            const hiddenInput = document.getElementById('source_of_fund');
            suggestions.innerHTML = '';
            if (!query) {
                suggestions.classList.add('hidden');
                hiddenInput.value = '';
                return;
            }
            const matches = sofOptions.filter(opt => opt.label.toLowerCase().includes(query.toLowerCase()));
            if (matches.length === 0) {
                suggestions.classList.add('hidden');
                hiddenInput.value = '';
                return;
            }
            matches.forEach(opt => {
                const li = document.createElement('li');
                li.className = 'px-3 py-2 hover:bg-blue-100 cursor-pointer';
                li.textContent = opt.label;
                li.onclick = () => {
                    input.value = opt.label;
                    hiddenInput.value = opt.value;
                    suggestions.classList.add('hidden');
                };
                suggestions.appendChild(li);
            });
            suggestions.classList.remove('hidden');
        }

        // Hide suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!document.getElementById('sof_search').contains(e.target)) {
                document.getElementById('sof_suggestions').classList.add('hidden');
            }
        });
    </script>

    {% comment %} This is the ajax functionality on the add item table using vanilla js. I commented this code to test the htmx ajax
    <script>
        document.getElementById('add-item').addEventListener('click', function() {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            fetch("{% url 'add_purchase_item' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'stock_no': document.getElementById('stock_no').value,
                    'unit': document.getElementById('unit').value,
                    'item_desc': document.getElementById('item_desc').value,
                    'quantity': document.getElementById('quantity').value,
                    'unit_cost': document.getElementById('unit_cost').value,
                })
            })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    // Clear input fields
                    document.querySelectorAll('#input-row input').forEach(input => input.value = '');
                    
                    // Refresh items list
                    fetch("{% url 'purchase_request_form' %}")
                        .then(response => response.text())
                        .then(html => {
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(html, 'text/html');
                            const newTableBody = doc.getElementById('items-table-body').innerHTML;
                            document.getElementById('items-table-body').innerHTML = newTableBody;
                        });
                }
            });
        });
    </script> {% endcomment %}
{% endblock main-content %}